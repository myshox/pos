# 多台裝置同步設定（Supabase）

設定完成後，多台手機／裝置會共用同一份商品、訂單、分類與店鋪設定，並即時同步。

**快速檢查**：設定好後到 後台 → 備份與還原，若出現「同步已啟用」且連線正常，即表示成功。

---

## 1. 建立 Supabase 專案

1. 前往 [supabase.com](https://supabase.com) 註冊／登入。
2. 點 **New project**，選組織、輸入專案名稱（例如 `pos-sync`）、設密碼，建立專案。
3. 進入專案後，左側 **Project Settings** → **API**，記下：
   - **Project URL**（例如 `https://xxxx.supabase.co`）
   - **anon public** 的 **API Key**

## 2. 建立資料表

左側選 **SQL Editor**，新增查詢，貼上以下 SQL 後執行：

```sql
-- 單一資料列，存放整個店鋪資料（商品、訂單、分類、店鋪設定）
create table if not exists store_data (
  id text primary key default 'default',
  -- 店鋪密鑰：用 request header 的 x-store-key 驗證
  store_key text not null default '',
  products jsonb not null default '[]',
  orders jsonb not null default '[]',
  categories jsonb not null default '[]',
  store_settings jsonb not null default '{}',
  updated_at timestamptz not null default now()
);

-- 先啟用 RLS
alter table store_data enable row level security;

-- === 店鋪密鑰方案（推薦）：只允許帶正確 x-store-key 的讀寫 ===
-- 1) 先刪掉舊的開放 policy（如果你之前跑過 Allow all）
drop policy if exists "Allow all for store_data" on public.store_data;

-- 2) 設定你的店鋪密鑰（請改成你自己的字串）
--    初次建立後建議就固定，不要公開分享
update public.store_data
set store_key = '請換成你的店鋪密鑰'
where id = 'default';

-- 3) 建立只允許正確 header 的 policy
create policy "store_data_read_with_key"
  on public.store_data for select
  using (
    coalesce((current_setting('request.headers', true))::json->>'x-store-key', '') = store_key
  );

create policy "store_data_write_with_key"
  on public.store_data for insert
  with check (
    coalesce((current_setting('request.headers', true))::json->>'x-store-key', '') = store_key
  );

create policy "store_data_update_with_key"
  on public.store_data for update
  using (
    coalesce((current_setting('request.headers', true))::json->>'x-store-key', '') = store_key
  )
  with check (
    coalesce((current_setting('request.headers', true))::json->>'x-store-key', '') = store_key
  );

-- 啟用 Realtime，讓多台裝置即時收到更新
alter publication supabase_realtime add table store_data;
```

若 `alter publication supabase_realtime add table store_data` 報錯，可改在 Supabase 後台 **Database** → **Replication** 裡把 `store_data` 加入 Replication。

## 3. 設定環境變數

在專案根目錄新增 `.env`（不要提交到 Git），內容：

```
VITE_SUPABASE_URL=你的 Project URL
VITE_SUPABASE_ANON_KEY=你的 anon public API Key
VITE_STORE_KEY=你的店鋪密鑰（需與資料庫 store_data.store_key 相同）
```

例如：

```
VITE_SUPABASE_URL=https://abcdefgh.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## 4. 重新建置與部署

- 本機：`npm run build` 或 `npm run dev`，會讀取 `.env`。
- Vercel／Cloudflare：在該平台的 **Environment Variables** 新增 `VITE_SUPABASE_URL` 與 `VITE_SUPABASE_ANON_KEY`，再重新部署。

## 行為說明

- **未設定**上述兩個環境變數：與之前相同，僅使用本機 localStorage，不會同步。
- **已設定**：  
  - 開啟 App 時會從雲端載入資料（若有），並訂閱即時更新。  
  - 任一裝置變更商品、訂單、分類或店鋪設定時，約 1.5 秒內會上傳到 Supabase，其他裝置會自動收到並更新畫面。  
  - 本機仍會寫入 localStorage，離線時可繼續使用，下次連線後會再與雲端同步。

## 注意

- PIN 碼僅存於各裝置本機，**不會**同步到雲端（安全考量）。
- 同一時間多台裝置編輯時，以**最後寫入**為準（last-write-wins）。
- 店鋪密鑰（`VITE_STORE_KEY`）請不要公開分享；若曾外流，請更換 `store_data.store_key` 與各部署環境變數。
