# 多台裝置同步設定（Supabase）

設定完成後，多台手機／裝置會共用同一份商品、訂單、分類與店鋪設定，並即時同步。

## 1. 建立 Supabase 專案

1. 前往 [supabase.com](https://supabase.com) 註冊／登入。
2. 點 **New project**，選組織、輸入專案名稱（例如 `pos-sync`）、設密碼，建立專案。
3. 進入專案後，左側 **Project Settings** → **API**，記下：
   - **Project URL**（例如 `https://xxxx.supabase.co`）
   - **anon public** 的 **API Key**

## 2. 建立資料表

左側選 **SQL Editor**，新增查詢，貼上以下 SQL 後執行：

```sql
-- 單一資料列，存放整個店鋪資料（商品、訂單、分類、店鋪設定）
create table if not exists store_data (
  id text primary key default 'default',
  products jsonb not null default '[]',
  orders jsonb not null default '[]',
  categories jsonb not null default '[]',
  store_settings jsonb not null default '{}',
  updated_at timestamptz not null default now()
);

-- 允許匿名讀寫（此專案為單一店鋪、無登入，依需求可改為 RLS 限制）
alter table store_data enable row level security;

create policy "Allow all for store_data"
  on store_data for all
  using (true)
  with check (true);

-- 啟用 Realtime，讓多台裝置即時收到更新
alter publication supabase_realtime add table store_data;
```

若 `alter publication supabase_realtime add table store_data` 報錯，可改在 Supabase 後台 **Database** → **Replication** 裡把 `store_data` 加入 Replication。

## 3. 設定環境變數

在專案根目錄新增 `.env`（不要提交到 Git），內容：

```
VITE_SUPABASE_URL=你的 Project URL
VITE_SUPABASE_ANON_KEY=你的 anon public API Key
```

例如：

```
VITE_SUPABASE_URL=https://abcdefgh.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## 4. 重新建置與部署

- 本機：`npm run build` 或 `npm run dev`，會讀取 `.env`。
- Vercel／Cloudflare：在該平台的 **Environment Variables** 新增 `VITE_SUPABASE_URL` 與 `VITE_SUPABASE_ANON_KEY`，再重新部署。

## 行為說明

- **未設定**上述兩個環境變數：與之前相同，僅使用本機 localStorage，不會同步。
- **已設定**：  
  - 開啟 App 時會從雲端載入資料（若有），並訂閱即時更新。  
  - 任一裝置變更商品、訂單、分類或店鋪設定時，約 1.5 秒內會上傳到 Supabase，其他裝置會自動收到並更新畫面。  
  - 本機仍會寫入 localStorage，離線時可繼續使用，下次連線後會再與雲端同步。

## 注意

- PIN 碼僅存於各裝置本機，**不會**同步到雲端（安全考量）。
- 同一時間多台裝置編輯時，以**最後寫入**為準（last-write-wins）。
